name: Docker Image CI

on:
  workflow_dispatch:
    inputs:
      docker-tag:
        description: 'Docker image tag'
        required: true
        default: '1.0.0'
  
jobs:
  build:
    name: Build & push docker image
    runs-on: ubuntu-latest
    env:
      IMG_NAME: niazovd/api

    steps:

    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # required for github-action-get-previous-tag

    - name: Get Previous tag
      id: previoustag
      uses: 'WyriHaximus/github-action-get-previous-tag@v1'
      env:
        GITHUB_TOKEN: ${{ secrets.ACTION_TOKEN }}

    - name: Get next version
      id: next
      uses: 'WyriHaximus/github-action-next-release-version@1.0.0'
      with:
        version: ${{ steps.previoustag.outputs.tag }}        
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v2
      with:
        context: ./api
        push: ${{ env.IMG_NAME }}
        tags: |
          '${{ github.event.inputs.docker-tag }}'
          latest
        labels: '${{ github.event.inputs.docker-tag }}'
